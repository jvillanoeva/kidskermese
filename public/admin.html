<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kids Kermesse â€” Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; min-height: 100vh; }

    /* Login screen */
    .login-screen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 24px;
    }
    .login-card {
      background: white; border-radius: 20px; padding: 40px;
      max-width: 380px; width: 100%;
      box-shadow: 0 8px 40px rgba(0,0,0,0.08); text-align: center;
    }
    .login-card h1 { font-size: 22px; font-weight: 800; color: #1a1a2e; margin-bottom: 6px; }
    .login-card p { color: #aaa; font-size: 14px; margin-bottom: 24px; }
    .login-card input {
      width: 100%; padding: 14px 16px; border: 2px solid #e8e8e8;
      border-radius: 12px; font-size: 15px; outline: none; margin-bottom: 12px;
    }
    .login-card input:focus { border-color: #ff6b35; }
    .login-card button {
      width: 100%; padding: 14px; background: #ff6b35; color: white;
      border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;
    }
    .login-card button:hover { background: #e85a25; }
    .login-error { color: #e74c3c; font-size: 13px; margin-top: 10px; display: none; }

    /* Dashboard */
    .dashboard { display: none; padding: 32px; }
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 28px; flex-wrap: wrap; gap: 12px;
    }
    .topbar h1 { font-size: 22px; font-weight: 800; color: #1a1a2e; }
    .topbar a {
      background: #1a1a2e; color: white; padding: 10px 20px;
      border-radius: 10px; text-decoration: none; font-size: 14px; font-weight: 600;
    }

    /* Stats */
    .stats { display: flex; gap: 16px; margin-bottom: 28px; flex-wrap: wrap; }
    .stat-card {
      background: white; border-radius: 16px; padding: 20px 24px;
      flex: 1; min-width: 140px; box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }
    .stat-card .label { font-size: 12px; color: #aaa; font-weight: 600; text-transform: uppercase; }
    .stat-card .value { font-size: 32px; font-weight: 800; color: #1a1a2e; margin-top: 4px; }
    .stat-card.highlight .value { color: #ff6b35; }

    /* Search */
    .search-bar {
      background: white; border-radius: 12px; padding: 12px 16px;
      display: flex; gap: 12px; margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }
    .search-bar input {
      flex: 1; border: none; outline: none; font-size: 15px; color: #1a1a2e;
    }

    /* Table */
    .table-wrap {
      background: white; border-radius: 16px; overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #1a1a2e; }
    thead th { color: white; padding: 14px 16px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    tbody tr { border-bottom: 1px solid #f5f5f5; }
    tbody tr:hover { background: #fff8f0; }
    tbody td { padding: 14px 16px; font-size: 14px; color: #333; }
    .badge-in { background: #e8f8f0; color: #27ae60; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; }
    .badge-out { background: #f5f5f5; color: #aaa; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; }
    .empty { text-align: center; padding: 48px; color: #aaa; }
  </style>
</head>
<body>

  <!-- Login -->
  <div class="login-screen" id="login-screen">
    <div class="login-card">
      <div style="font-size:40px; margin-bottom:12px;">ðŸŽª</div>
      <h1>Kids Kermesse</h1>
      <p>Panel de administraciÃ³n</p>
      <input type="password" id="password-input" placeholder="ContraseÃ±a" />
      <button onclick="login()">Entrar</button>
      <p class="login-error" id="login-error">ContraseÃ±a incorrecta</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="topbar">
      <h1>ðŸŽª Kids Kermesse â€” Admin</h1>
      <a href="/scan.html">ðŸ“· Escanear en puerta</a>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="label">Total registros</div>
        <div class="value" id="stat-total">â€”</div>
      </div>
      <div class="stat-card highlight">
        <div class="label">Ya ingresaron</div>
        <div class="value" id="stat-checked">â€”</div>
      </div>
      <div class="stat-card">
        <div class="label">Pendientes</div>
        <div class="value" id="stat-pending">â€”</div>
      </div>
    </div>

    <div class="search-bar">
      <input type="text" id="search" placeholder="Buscar por nombre o estudiante..." oninput="filterTable()" />
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Estudiante</th>
            <th>Correo</th>
            <th>Registro</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="5" class="empty">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API = 'https://kidskermese-production.up.railway.app';
    let allData = [];
    let savedPassword = '';

    function login() {
      const pw = document.getElementById('password-input').value;
      if (!pw) return;
      savedPassword = pw;
      loadData();
    }

    document.getElementById('password-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') login();
    });

    async function loadData() {
      try {
        const res = await fetch(`${API}/admin/registrations?password=${encodeURIComponent(savedPassword)}`);
        if (res.status === 401) {
          document.getElementById('login-error').style.display = 'block';
          return;
        }
        const data = await res.json();
        allData = data;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        renderTable(data);
        renderStats(data);
      } catch (err) {
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('login-error').textContent = 'Error de conexiÃ³n. Intenta de nuevo.';
      }
    }

    function renderStats(data) {
      const checked = data.filter(r => r.checked_in).length;
      document.getElementById('stat-total').textContent = data.length;
      document.getElementById('stat-checked').textContent = checked;
      document.getElementById('stat-pending').textContent = data.length - checked;
    }

    function renderTable(data) {
      const tbody = document.getElementById('table-body');
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">Sin registros aÃºn</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(r => `
        <tr>
          <td><strong>${r.name}</strong></td>
          <td>${r.student_name}</td>
          <td>${r.email}</td>
          <td>${new Date(r.created_at).toLocaleDateString('es-MX', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' })}</td>
          <td>${r.checked_in
            ? `<span class="badge-in">âœ… IngresÃ³</span>`
            : `<span class="badge-out">Pendiente</span>`
          }</td>
        </tr>
      `).join('');
    }

    function filterTable() {
      const q = document.getElementById('search').value.toLowerCase();
      const filtered = allData.filter(r =>
        r.name.toLowerCase().includes(q) ||
        r.student_name.toLowerCase().includes(q) ||
        r.email.toLowerCase().includes(q)
      );
      renderTable(filtered);
    }

    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (savedPassword) loadData();
    }, 30000);
  </script>

</body>
</html>
